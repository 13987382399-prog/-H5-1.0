<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>äº‘å—å‰§æœ¬æ¸¸</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "SF Pro Text", "PingFang SC", "Microsoft YaHei", sans-serif;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç‚¹å‡»é«˜äº® */
        }

        /* åœ°å›¾å®¹å™¨ */
        #map-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        /* éšè—åœ°å›¾Logoå’Œç‰ˆæƒä¿¡æ¯ */
        .logo-text, img[src*="logo_def.png"], .tmap-scale-control, .tmap-zoom-control {
            display: none !important;
        }

        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* é˜²æ­¢å‡ºç°æ»šåŠ¨æ¡ */
            background: #ffffff; /* ç¡®ä¿èƒŒæ™¯çº¯ç™½ï¼Œé¿å…çœ‹ä¼¼è¾¹æ¡† */
        }

        /* æ‰‹æœºå®¹å™¨ - å…¨å±é€‚é… */
        .phone-container {
            width: 100%;
            height: 100%;
            border: none !important;
            border-radius: 0 !important;
            background: #fff;
            overflow: hidden;
            position: relative;
            box-shadow: none !important;
        }

        /* å±å¹•å†…å®¹åŒº - ç§»é™¤æ‰€æœ‰èƒŒæ™¯ç›¸å…³å†…å®¹ */
        .screen-content {
            width: 100%;
            height: 100%;
            position: relative;
            background: #ffffff; /* çº¯ç™½è‰²èƒŒæ™¯ */
            overflow: hidden;
        }

        /* é™„è¿‘æ¨èæ»šåŠ¨æ  - èƒŒæ™¯é€æ˜åº¦è°ƒæ•´ä¸º90% */
        .nearby-recommend {
            position: absolute;
            top: env(safe-area-inset-top, 20px);
            left: 0;
            width: 100%;
            padding: 0 20px;
            z-index: 2;
            background: rgba(255,255,255,0.9);
            padding-top: 10px;
            padding-bottom: 2px; /* è¿›ä¸€æ­¥å‹ç¼©åº•éƒ¨ç©ºé—´ */
            border-radius: 0 0 16px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .recommend-title {
            font-size: 16px;
            font-weight: 600;
            color: #334155; /* æ·±ç°è“ï¼Œæ¯”çº¯é»‘æŸ”å’Œï¼Œæ¯”æµ…ç°æ¸…æ™° */
            /* margin-bottom: 8px; ç§»äº¤ç»™çˆ¶å®¹å™¨æ§åˆ¶ */
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .recommend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px; /* å‡å°é—´è·ï¼Œç”±scrollå®¹å™¨paddingè¡¥å…… */
        }

        .weather-widget {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #64748b;
            background: rgba(255, 255, 255, 0.6);
            padding: 4px 10px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            backdrop-filter: blur(4px);
        }

        .weather-icon {
            font-size: 16px;
        }

        .weather-temp {
            font-weight: 600;
            color: #334155;
        }

        .recommend-title::before {
            content: '';
            display: inline-block;
            width: 4px;
            height: 16px;
            background: linear-gradient(135deg, #6ad4ff, #14b6fa);
            border-radius: 2px;
        }

        /* å…è®¸æ¨ªå‘æ»šåŠ¨å¹¶éšè—æ»šåŠ¨æ¡ */
        .recommend-scroll {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            position: relative;
            -ms-overflow-style: none;
            scrollbar-width: none;
            /* è°ƒæ•´å†…è¾¹è·ï¼šåº•éƒ¨ç¨å¾®å‡å°ä»¥é…åˆæ•´ä½“å‹ç¼©ï¼ŒåŒæ—¶ä¿ç•™é˜´å½±ç©ºé—´ */
            padding: 12px 4px 6px 4px;
        }
        
        /* éšè—Chrome/Safariçš„æ»šåŠ¨æ¡ */
        .recommend-scroll::-webkit-scrollbar {
            display: none;
        }

        /* è‡ªåŠ¨æ»šåŠ¨å®¹å™¨ */
        .scroll-wrapper {
            display: inline-block;
            animation: scrollLeft 50s linear infinite;
            user-select: none;
        }

        /* è‡ªåŠ¨æ»šåŠ¨åŠ¨ç”» */
        @keyframes scrollLeft {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-50%);
            }
        }

        /* é¼ æ ‡æ‚¬åœ/æ‹–æ‹½æ—¶æš‚åœæ»šåŠ¨ */
        .recommend-scroll:hover .scroll-wrapper,
        .recommend-scroll.dragging .scroll-wrapper {
            animation-play-state: paused;
        }

        .recommend-item {
            display: inline-block;
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 10px 12px;
            margin-right: 10px;
            box-shadow: 0 2px 8px rgba(20, 182, 250, 0.1);
            border: 1px solid #e0f6ff;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 140px;
            user-select: none;
        }

        .recommend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(20, 182, 250, 0.15);
            border-color: #8edeff;
            background: rgba(255,255,255,1);
        }

        .recommend-item:hover .item-title,
        .recommend-item:hover .item-desc {
            color: #14b6fa;
        }

        /* æŸ¥çœ‹è¯¦æƒ…æ  - æ‹‰ç¯ç‰ˆ */
        .view-details-bar {
            width: 100%;
            height: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-top: 0;
            margin-bottom: 2px;
            opacity: 0.8;
            transition: all 0.2s;
        }

        .pull-handle {
            width: 36px;
            height: 4px;
            background-color: #cbd5e1;
            border-radius: 2px;
            transition: background-color 0.2s, transform 0.2s;
        }

        .view-details-bar:hover .pull-handle {
            background-color: #14b6fa;
            transform: scaleX(1.1);
        }

        .view-details-bar:hover {
            transform: translateY(2px);
        }

        /* ç§»é™¤æ—§çš„iconæ ·å¼ */

        /* åˆ†ç±»å›¾æ ‡æ ·å¼ */
        .item-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 6px;
            vertical-align: middle;
            border-radius: 4px;
            background-color: #e0f6ff;
            color: #14b6fa;
            text-align: center;
            line-height: 20px;
            font-size: 14px;
            font-weight: normal;
        }

        .item-title {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }

        .item-desc {
            font-size: 12px;
            color: #666;
            padding-left: 26px;
        }

        /* AIä¼´æ¸¸æŒ‰é’® (åˆå¹¶åçš„æ ·å¼) */
        .ai-button {
            position: absolute;
            bottom: 240px; /* åˆå§‹ä½ç½® */
            right: 25px;
            width: 90px; /* æ”¾å¤§50% (60px * 1.5) */
            height: 90px; /* æ”¾å¤§50% (60px * 1.5) */
            border-radius: 50%;
            /* ç§»é™¤èƒŒæ™¯è‰²ã€è¾¹æ¡† */
            background-image: url('./20260219-202331.gif');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            z-index: 1000;
            touch-action: none;
            transition: transform 0.3s ease;
            /* å¢åŠ ç«‹ä½“é˜´å½± */
            box-shadow: 
                0 2px 7.5px rgba(0, 0, 0, 0.2), /* åŸºç¡€æŠ•å½± */
                0 4px 12.5px rgba(20, 182, 250, 0.25), /* è“è‰²æ°›å›´å…‰ */
                inset 0 0 0 1px rgba(255, 255, 255, 0.2); /* å†…éƒ¨å¾®å…‰æè¾¹ */
            
            &:hover {
                transform: scale(1.1) rotate(5deg);
                box-shadow: 
                    0 3px 10px rgba(0, 0, 0, 0.25),
                    0 5px 15px rgba(20, 182, 250, 0.35),
                    inset 0 0 0 1px rgba(255, 255, 255, 0.3);
            }
            
            &:active {
                transform: scale(1.05) rotate(2deg);
            }
        }

        /* åŠŸèƒ½æŒ‰é’®åŒº */
        .function-buttons {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px 24px calc(10px + env(safe-area-inset-bottom, 0px)); /* é€‚é…åº•éƒ¨å®‰å…¨åŒº */
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            /* ç»ç’ƒæ‹Ÿæ€æ•ˆæœ */
            background: rgba(255, 255, 255, 0.9); /* è°ƒæ•´é€æ˜åº¦ä¸é™„è¿‘æ¨èä¸€è‡´ */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255, 255, 255, 0.6);
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* å…³é”®ï¼šé˜²æ­¢çˆ¶å®¹å™¨è£åˆ‡å­å…ƒç´ é˜´å½± */
            overflow: visible;
        }

        .func-grid {
            width: calc(100% + 10px);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            max-height: 125px; /* ç¨å¾®å¢åŠ é«˜åº¦ä»¥å®¹çº³é˜´å½± */
            /* å…³é”®ä¿®æ”¹ï¼šå…è®¸xè½´æº¢å‡ºä»¥æ˜¾ç¤ºé˜´å½±ï¼Œyè½´ä½¿ç”¨hiddené…åˆåŠ¨ç”» */
            overflow-y: hidden;
            overflow-x: visible;
            transition: max-height 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            /* å¢åŠ paddingå®¹çº³é˜´å½± */
            padding: 5px;
            padding-bottom: 15px; /* å¢åŠ åº•éƒ¨paddingï¼Œä¸“é—¨å®¹çº³ç«‹ä½“é˜´å½± */
            /* ä½¿ç”¨è´ŸmarginæŠµæ¶ˆpaddingï¼Œä¿æŒå¸ƒå±€å¯¹é½ */
            margin: -5px;
            margin-bottom: -15px; /* æŠµæ¶ˆåº•éƒ¨padding */
        }
        
        /* å±•å¼€çŠ¶æ€ */
        .function-buttons.expanded .func-grid {
            max-height: 500px; /* è¶³å¤Ÿæ˜¾ç¤ºæ‰€æœ‰è¡Œ */
        }

        .more-func-trigger {
            margin-top: 24px; /* å¢åŠ é¡¶éƒ¨é—´è·ï¼Œè®©æŒ‰é’®ä¸‹ç§» */
            font-size: 13px;
            color: #666; /* è°ƒæ•´ä¸ºä¸åŠ è½½æç¤ºä¸€è‡´çš„ç°è‰² */
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            opacity: 0.8;
            transition: all 0.3s;
            padding: 4px 12px;
            border-radius: 12px;
        }
        
        .more-func-trigger:hover {
            opacity: 1;
            color: #14b6fa;
            background: rgba(20, 182, 250, 0.05); /* æµ…è“è‰²èƒŒæ™¯ */
        }
        
        .more-arrow {
            display: inline-block;
            transition: transform 0.3s;
            font-size: 10px;
        }
        
        .function-buttons.expanded .more-arrow {
            transform: rotate(180deg);
        }

        /* èŠå¤©çª—å£æ ·å¼ */
        .chat-modal {
            position: absolute; /* æ”¹ä¸ºabsoluteï¼Œç›¸å¯¹äºæ‰‹æœºå®¹å™¨å®šä½ */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            border-radius: 0; /* å…¨å±æ¨¡å¼ç§»é™¤åœ†è§’ */
        }

        @keyframes slideUp {
            0% { transform: translateY(100%); }
            100% { transform: translateY(0); }
        }

        .chat-header {
            padding: 12px 16px; /* å‡å°paddingä»¥ç¼©çŸ­é«˜åº¦ */
            background: linear-gradient(135deg, #6ad4ff, #14b6fa);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(20, 182, 250, 0.2);
            min-height: 56px; /* ç¡®ä¿æœ€å°é«˜åº¦ */
        }

        .chat-title {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 2px; /* å‡å°é—´è· */
        }

        .chat-close {
            cursor: pointer;
            font-size: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .chat-close:hover { 
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.6;
            position: relative;
            word-wrap: break-word;
            margin-bottom: 4px;
            transition: all 0.3s ease;
        }

        .message.user {
            align-self: flex-end;
            background: linear-gradient(135deg, #14b6fa, #0ea5e9);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(20, 182, 250, 0.2);
        }

        .message.ai {
            align-self: flex-start;
            background: white;
            color: #334155;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        /* ç§»é™¤å–‡å­å›¾æ ‡æ ·å¼ */

        .chat-input-area {
            padding: 16px 20px;
            background: white;
            border-top: 1px solid #f0f0f0;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
            position: relative;
            z-index: 10;
        }

        .text-input-row {
            width: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .input-wrapper {
            flex: 1;
            background: #f0f4f8; /* ç¨å¾®åŠ æ·±èƒŒæ™¯è‰²ä»¥çªå‡ºå†…é˜´å½± */
            border-radius: 24px;
            padding: 4px 16px;
            display: flex;
            align-items: center;
            border: 1px solid #dae1e7; /* è¾¹æ¡†é¢œè‰²å¾®è°ƒ */
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            height: 44px;
            /* å¢å¼ºç«‹ä½“æ•ˆæœï¼šå†…é˜´å½±æ¨¡æ‹Ÿå‡¹é™· */
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.08), 0 1px 0 rgba(255,255,255,0.8);
        }

        .input-wrapper:focus-within {
            border-color: #14b6fa;
            background: white;
            box-shadow: 0 0 0 3px rgba(20, 182, 250, 0.15), inset 0 1px 3px rgba(0,0,0,0.05);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0;
            font-size: 15px;
            color: #334155;
            outline: none;
            width: 100%;
            height: 100%;
        }

        .chat-input::placeholder {
            color: #94a3b8;
            font-size: 14px;
            text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }

        .action-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 20px;
            flex-shrink: 0;
        }

        .send-btn {
            /* é»˜è®¤ç°è‰²çŠ¶æ€ */
            background: #e2e8f0;
            color: #94a3b8;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.06);
            font-size: 18px;
            pointer-events: none; /* æ— å†…å®¹æ—¶ä¸å¯ç‚¹å‡» */
            transform: scale(0.95);
            opacity: 0.8;
            transition: all 0.3s ease;
        }

        .send-btn.active {
            /* æ¿€æ´»è“è‰²çŠ¶æ€ */
            background: linear-gradient(135deg, #14b6fa, #0ea5e9);
            color: white;
            box-shadow: 0 4px 12px rgba(20, 182, 250, 0.4), inset 0 1px 0 rgba(255,255,255,0.3);
            pointer-events: auto;
            transform: scale(1);
            opacity: 1;
        }

        .send-btn.active:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 16px rgba(20, 182, 250, 0.5), inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .send-btn.active:active {
            transform: scale(0.95);
        }

        .voice-hold-btn {
            width: 100%;
            height: 48px;
            border-radius: 24px;
            border: none;
            background: linear-gradient(to bottom, #ffffff, #f1f5f9); /* æ¸å˜èƒŒæ™¯ */
            color: #334155;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            outline: none;
            /* å¢å¼ºç«‹ä½“æ•ˆæœï¼šæµ®èµ·é˜´å½± + è¾¹æ¡† */
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1), 
                0 2px 4px -1px rgba(0, 0, 0, 0.06), 
                inset 0 1px 0 rgba(255,255,255,1);
            border: 1px solid #e2e8f0;
            text-shadow: 0 1px 0 rgba(255,255,255,1);
        }

        .voice-hold-btn:active {
            background: #e2e8f0;
            transform: scale(0.98);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .voice-hold-btn.recording {
            background: linear-gradient(135deg, #14b6fa, #0ea5e9);
            color: white;
            box-shadow: 0 4px 12px rgba(20, 182, 250, 0.3);
            animation: pulse-blue 1.5s infinite;
        }

        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(20, 182, 250, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(20, 182, 250, 0); }
            100% { box-shadow: 0 0 0 0 rgba(20, 182, 250, 0); }
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 4px 8px;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #ccc;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .seagull-span-icon {
            width: 63px;
            height: 63px;
            object-fit: contain;
            vertical-align: middle;
            margin-right: 0;
            /* ç¨å¾®è°ƒæ•´ä½ç½®ä»¥å¯¹é½æ–‡æœ¬ */
            position: relative;
            top: 0;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        /* é¡¶éƒ¨æ‹–æ‹½æ¡æŒ‡ç¤ºå™¨ */
        .drag-handle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 24px; /* å¢åŠ ç‚¹å‡»çƒ­åŒºé«˜åº¦ */
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2;
            transition: all 0.2s; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        }

        .drag-handle::after {
            content: '';
            width: 36px;
            height: 4px;
            background-color: #cbd5e1; /* ç»Ÿä¸€é¢œè‰² */
            border-radius: 2px;
            transition: background-color 0.2s, transform 0.2s;
        }

        .drag-handle:hover::after {
            background-color: #14b6fa; /* æ‚¬åœå˜è“ */
            transform: scaleX(1.1); /* æ‚¬åœå˜é•¿ */
        }
        
        .drag-handle:hover {
            transform: translateY(2px); /* æ‚¬åœä¸‹ç§» */
        }

        /* åŠŸèƒ½æŒ‰é’® */
        .func-btn {
            padding: 12px 10px;
            /* 3D background gradient */
            background: linear-gradient(180deg, #FFFFFF 0%, #F0F7FF 100%);
            border: 1px solid #E0F2FE;
            border-radius: 28px;
            
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            
            text-align: center;
            color: #475569;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease-out;
            
            /* Deep shadow for 3D float */
            box-shadow: 
                0 4px 6px -1px rgba(20, 182, 250, 0.1), /* Soft drop */
                0 10px 15px -3px rgba(20, 182, 250, 0.1), /* Deep drop */
                inset 0 -3px 0 rgba(20, 182, 250, 0.1), /* Subtle bottom inner shadow for thickness */
                inset 0 0 0 1px rgba(255,255,255,0.6); /* Inner stroke */
        }
        
        .func-btn:hover {
            transform: translateY(-2px);
            color: #14b6fa; /* æ‚¬åœæ—¶æ–‡å­—å˜è“ */
            background: linear-gradient(180deg, #FFFFFF 0%, #E0F2FE 100%);
            box-shadow: 
                0 8px 15px -2px rgba(20, 182, 250, 0.15),
                0 15px 25px -5px rgba(20, 182, 250, 0.15),
                inset 0 -3px 0 rgba(20, 182, 250, 0.15),
                inset 0 0 0 1px rgba(255,255,255,0.8);
        }
        
        .func-btn:active {
            transform: translateY(1px);
            box-shadow: 
                0 2px 4px -1px rgba(20, 182, 250, 0.1),
                inset 0 2px 4px rgba(0, 0, 0, 0.05);
            background: #F0F9FF;
        }
        
        /* æŒ‰é’®å›¾æ ‡æ ·å¼ */
        .func-btn-icon {
            width: 24px;
            height: 24px;
            object-fit: contain;
            /* ç¨å¾®è°ƒæ•´å›¾æ ‡ä½ç½®ä»¥è§†è§‰å±…ä¸­ */
            margin-top: -1px;
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
            100% {
                transform: scale(0.95);
                opacity: 1;
            }
        }
        
        /* å®šä½è¯·æ±‚æç¤ºæ¡†æ ·å¼ - ç¼©å°40% (åŸ300px â†’ 180px) */
        .location-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 16.8px 14.4px; /* åŒæ­¥ç¼©å°å†…è¾¹è·40% */
            border-radius: 12px; /* åŒæ­¥ç¼©å°åœ†è§’40% */
            box-shadow: 0 6px 24px rgba(0,0,0,0.25); /* åŒæ­¥ç¼©å°é˜´å½±40% */
            width: 180px; /* åŸ300px â†’ ç¼©å°40% = 180px */
            z-index: 9999;
            text-align: center;
            font-size: 9px; /* åŒæ­¥ç¼©å°å­—ä½“40% */
            color: #333;
            border: 1px solid #f0e6ff;
        }
        
        .location-icon {
            font-size: 19.2px; /* åŒæ­¥ç¼©å°40% */
            color: #14b6fa;
            margin-bottom: 9.6px; /* åŒæ­¥ç¼©å°40% */
            display: block;
        }
        
        .location-title {
            font-size: 10.8px; /* åŒæ­¥ç¼©å°40% */
            font-weight: 600;
            color: #14b6fa;
            margin-bottom: 7.2px; /* åŒæ­¥ç¼©å°40% */
        }
        
        .location-desc {
            font-size: 8.4px; /* åŒæ­¥ç¼©å°40% */
            color: #666;
            line-height: 1.5;
            margin-bottom: 14.4px; /* åŒæ­¥ç¼©å°40% */
            text-align: left; /* æ–°å¢ï¼šæ–‡æœ¬å·¦å¯¹é½ */
        }
        
        .location-buttons {
            display: flex;
            gap: 7.2px; /* åŒæ­¥ç¼©å°40% */
            justify-content: center;
        }
        
        .location-btn {
            padding: 6px 12px; /* åŒæ­¥ç¼©å°40% */
            border-radius: 14.4px; /* åŒæ­¥ç¼©å°40% */
            font-size: 8.4px; /* åŒæ­¥ç¼©å°40% */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            border: none;
        }
        
        .location-btn.allow {
            background: linear-gradient(135deg, #14b6fa, #6ad4ff);
            color: white;
        }
        
        .location-btn.allow:hover {
            background: linear-gradient(135deg, #0ea0e0, #5ac0eb);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(20, 182, 250, 0.3);
        }
        
        .location-btn.deny {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #eee;
        }
        
        .location-btn.deny:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        /* é®ç½©å±‚ */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9998;
            backdrop-filter: blur(2px);
        }

        /* æ‰‹åŠ¨é€‰æ‹©å®šä½ç•Œé¢æ ·å¼ */
        .manual-location-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.7); /* æ•´ä½“ç¼©å°30% */
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.25);
            width: 320px; /* ç¨å¾®åŠ å®½ä»¥å®¹çº³ä¸‰çº§è”åŠ¨ */
            z-index: 9999;
            text-align: center;
        }
        
        .manual-location-title {
            font-size: 18px;
            font-weight: 600;
            color: #14b6fa;
            margin-bottom: 16px;
        }
        
        .selector-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            text-align: left;
        }

        .selector-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .selector-label {
            font-size: 12px;
            color: #666;
            margin-left: 4px;
        }

        .custom-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            outline: none;
            background: #f9f9f9;
            transition: all 0.2s;
        }

        .custom-select:focus {
            border-color: #14b6fa;
            background: #fff;
            box-shadow: 0 0 0 2px rgba(20, 182, 250, 0.1);
        }
        
        .confirm-city-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #14b6fa, #6ad4ff);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
        }
    </style>
    <script charset="utf-8" src="https://map.qq.com/api/gljs?v=1.exp&key=CRMBZ-LDOK7-3AEXE-PPMU7-2Z2ST-HDBXB"></script>
</head>
<body>
    <div class="phone-container">
        <div class="screen-content">
            <div id="map-container"></div>
            <!-- é™„è¿‘æ¨èæ»šåŠ¨æ  -->
            <div class="nearby-recommend">
                <div class="recommend-header">
                    <div class="recommend-title">é™„è¿‘æ¨è</div>
                    <!-- å¤©æ°”å°ç»„ä»¶ -->
                    <div class="weather-widget" id="weatherWidget">
                        <span class="weather-icon">ğŸŒ¤ï¸</span>
                        <span class="weather-temp">--Â°C</span>
                        <span class="weather-city">å®šä½ä¸­...</span>
                    </div>
                </div>
                <div class="recommend-scroll" id="recommend-scroll">
                    <!-- è‡ªåŠ¨æ»šåŠ¨å®¹å™¨ -->
                    <div class="scroll-wrapper">
                        <!-- å†…å®¹å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                        <div style="padding: 20px; color: #666; font-size: 12px;">æ­£åœ¨AIè¯†åˆ«é™„è¿‘å†…å®¹...</div>
                    </div>
                </div>
                <!-- æŸ¥çœ‹è¯¦æƒ…æ  -->
                <div class="view-details-bar" id="viewDetailsBtn">
                    <div class="pull-handle"></div>
                </div>
            </div>

            <!-- AIä¼´æ¸¸æŒ‰é’® -->
            <div class="ai-button" id="ai-btn"></div>

            <!-- åŠŸèƒ½æŒ‰é’®ç»„ -->
            <div class="function-buttons" id="functionPanel">
                <div class="drag-handle" id="dragHandle"></div>
                <div class="func-grid">
                    <div class="func-btn">
                        <img src="./å¿«é—ªæ´»åŠ¨.png" class="func-btn-icon" alt="å›¾æ ‡">
                        <span>å¿«é—ªæ´»åŠ¨</span>
                    </div>
                    <div class="func-btn">
                        <img src="./çƒ­é—¨å‰§æœ¬.png" class="func-btn-icon" alt="å›¾æ ‡">
                        <span>çƒ­é—¨å‰§æœ¬</span>
                    </div>
                    <div class="func-btn">
                        <img src="./éé—æ‰‹å·¥.png" class="func-btn-icon" alt="å›¾æ ‡">
                        <span>éé—æ‰‹å·¥</span>
                    </div>
                    <div class="func-btn">
                        <img src="./æ‰“è·³èšç‚¹.png" class="func-btn-icon" alt="å›¾æ ‡">
                        <span>æ‰“è·³èšç‚¹</span>
                    </div>
                    <div class="func-btn">
                        <img src="./ä¸€é”®é¢„çº¦.png" class="func-btn-icon" alt="å›¾æ ‡">
                        <span>ä¸€é”®é¢„çº¦</span>
                    </div>
                    <div class="func-btn">
                        <img src="./æˆ‘çš„è®¾ç½®.png" class="func-btn-icon" alt="å›¾æ ‡">
                        <span>æˆ‘çš„è®¾ç½®</span>
                    </div>
                </div>
                <div class="more-func-trigger" id="moreTrigger">
                    æ›´å¤šåŠŸèƒ½ <span class="more-arrow">â–¼</span>
                </div>
            </div>
        </div>
    </div>


    <script>
        // æ¨¡æ‹ŸPOIæ•°æ® (ç”¨äºAIæ¨èç®—æ³•)
        const mockPois = [
            // å‰§æœ¬æ¸¸ (Script) - ğŸ­
            { type: 'script', title: 'æ°‘å›½å¾€äº‹å‰§æœ¬æ¸¸', desc: 'æ˜†æ˜è€è¡— æ²‰æµ¸å¼ä½“éªŒ', lat: 24.895, lng: 102.835, rating: 4.8 },
            { type: 'script', title: 'å¤å®…æƒŠé­‚å‰§æœ¬æ€', desc: 'è€å®…æ¢ç§˜ ææ€–å‡çº§', lat: 24.892, lng: 102.838, rating: 4.9 },
            { type: 'script', title: 'å¤§ç†æ­¦ä¾ å‰§æœ¬æ¸¸', desc: 'å¤§ç†å¤åŸ å¤é£æ¢è£…', lat: 25.69, lng: 100.16, rating: 4.7 },
            
            // ç¾é£Ÿ (Food) - ğŸœ
            { type: 'food', title: 'å»ºæ°´æ±½é”…é¸¡', desc: 'éé—ç¾é£Ÿ ç°ç‚¹ç°åš', lat: 24.893, lng: 102.832, rating: 4.9 },
            { type: 'food', title: 'è€è¡—è¿‡æ¡¥ç±³çº¿', desc: 'ç™¾å¹´è€åº— æ±¤é²œå‘³ç¾', lat: 24.896, lng: 102.834, rating: 4.8 },
            { type: 'food', title: 'å®˜æ¸¡å¤é•‡å°åƒ', desc: 'æ‰‹å·¥é¥µå— å¿…å°æ¨è', lat: 24.95, lng: 102.76, rating: 4.5 },

            // æ‹ç…§ (Photo) - ğŸ“¸
            { type: 'photo', title: 'é‡‘é©¬ç¢§é¸¡åŠæ‹ç…§', desc: 'å¤œæ™¯æ‹æ‘„ æœ€ä½³19:00', lat: 24.891, lng: 102.836, rating: 4.6 },
            { type: 'photo', title: 'é»„å…¬ä¸œè¡—', desc: 'æ–‡è‰ºå¤å¤ ç”µå½±æ„Ÿ', lat: 24.894, lng: 102.831, rating: 4.7 },
            { type: 'photo', title: 'æ»‡æ± æµ·é¸¥æ‰“å¡', desc: 'å–‚é¸¥æ‹ç…§ é“å…·å…è´¹', lat: 24.98, lng: 102.66, rating: 4.9 },

            // å¿«é—ª (Flash) - âš¡
            { type: 'flash', title: 'å—å±è¡—å¿«é—ª', desc: '16:00 æ°‘æ—èˆå¿«é—ª', lat: 24.892, lng: 102.837, rating: 4.5 },
            { type: 'flash', title: 'æ˜Ÿå…‰å¤œå¸‚å¿«é—ª', desc: '19:30 å‚£è¿ªäº’åŠ¨', lat: 24.90, lng: 102.84, rating: 4.6 },
            { type: 'flash', title: 'ç¿ æ¹–éŸ³ä¹å¿«é—ª', desc: '15:00 è¡—å¤´ä¹é˜Ÿ', lat: 24.905, lng: 102.825, rating: 4.7 },

            // çº¿è·¯ (Route) - ğŸ—ºï¸
            { type: 'route', title: 'èŒ¶é©¬å¤é“çº¿è·¯', desc: 'å¾’æ­¥ä½“éªŒ å«è®²è§£', lat: 24.89, lng: 102.83, rating: 4.9 },
            { type: 'route', title: 'è€è¡—å¯»å‘³è·¯çº¿', desc: 'åƒéåœ°é“å°åƒ', lat: 24.895, lng: 102.833, rating: 4.7 },
            { type: 'route', title: 'æ»‡æ± ç¯æ¹–çº¿è·¯', desc: 'éª‘è¡Œ/æ­¥è¡Œ 2å°æ—¶', lat: 24.98, lng: 102.66, rating: 4.8 }
        ];

        // è®¡ç®—ä¸¤ç‚¹è·ç¦» (Haversine formula)
        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // åœ°çƒåŠå¾„ km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            return R * c;
        }

        // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
        function showItemDetail(title, desc) {
            const alertBox = document.createElement('div');
            alertBox.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 16px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                width: 260px;
                z-index: 9999;
                text-align: center;
                font-size: 15px;
                color: #333;
            `;
            alertBox.innerHTML = `
                <div style="margin-bottom: 12px; color: #14b6fa; font-weight: 600;">${title}</div>
                <div style="font-size: 14px; color: #666; margin-bottom: 16px;">${desc}</div>
                <button style="
                    padding: 8px 24px;
                    background: #14b6fa;
                    color: white;
                    border: none;
                    border-radius: 20px;
                    font-size: 14px;
                    cursor: pointer;
                ">æŸ¥çœ‹è¯¦æƒ…</button>
            `;
            document.body.appendChild(alertBox);
            
            alertBox.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(alertBox);
            });
        }

        // æ›´æ–°æ¨èå†…å®¹ (AIæ¨èé€»è¾‘)
        function updateRecommendations(userLat, userLng) {
            // 1. è®¡ç®—è·ç¦»
            const poisWithDist = mockPois.map(poi => {
                return {
                    ...poi,
                    dist: getDistance(userLat, userLng, poi.lat, poi.lng)
                };
            });

            // 2. ç­›é€‰å’Œæ’åºè§„åˆ™
            const recommendations = [];

            // å‰§æœ¬æ¸¸ï¼šå‰§ â†’ ğŸ­ â†’ 2æ¡ â†’ è·ç¦»æœ€è¿‘
            const scripts = poisWithDist.filter(p => p.type === 'script')
                .sort((a, b) => a.dist - b.dist)
                .slice(0, 2);
            recommendations.push(...scripts);

            // ç¾é£Ÿï¼šé£Ÿ â†’ ğŸœ â†’ 2æ¡ â†’ è·ç¦»æœ€è¿‘ä¸”è¯„åˆ†æœ€é«˜
            // ç»¼åˆæ’åºï¼šè·ç¦»ä¼˜å…ˆï¼Œè¯„åˆ†è¾…åŠ© (è·ç¦» * 0.7 - è¯„åˆ† * 0.3) è¶Šå°è¶Šå¥½ï¼Œæˆ–è€…ç®€å•åœ°å…ˆæŒ‰è·ç¦»æ’åº
            const foods = poisWithDist.filter(p => p.type === 'food')
                .sort((a, b) => (a.dist - a.rating * 0.1) - (b.dist - b.rating * 0.1))
                .slice(0, 2);
            recommendations.push(...foods);

            // æ‹ç…§ï¼šæ‹ â†’ ğŸ“¸ â†’ 2æ¡ â†’ è·ç¦»æœ€è¿‘
            const photos = poisWithDist.filter(p => p.type === 'photo')
                .sort((a, b) => a.dist - b.dist)
                .slice(0, 2);
            recommendations.push(...photos);

            // å¿«é—ªï¼šé—ª â†’ âš¡ â†’ 2æ¡ â†’ è·ç¦»æœ€è¿‘
            const flashes = poisWithDist.filter(p => p.type === 'flash')
                .sort((a, b) => a.dist - b.dist)
                .slice(0, 2);
            recommendations.push(...flashes);

            // çº¿è·¯ï¼šçº¿ â†’ ğŸ—ºï¸ â†’ 1æ¡ â†’ è·ç¦»æœ€è¿‘
            const routes = poisWithDist.filter(p => p.type === 'route')
                .sort((a, b) => a.dist - b.dist)
                .slice(0, 1);
            recommendations.push(...routes);

            // 3. æ¸²æŸ“DOM
            const wrapper = document.querySelector('.scroll-wrapper');
            wrapper.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

            const renderItems = (items) => {
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'recommend-item';
                    
                    let icon = '';
                    if(item.type === 'script') icon = 'ğŸ­';
                    if(item.type === 'food') icon = 'ğŸœ';
                    if(item.type === 'photo') icon = 'ğŸ“¸';
                    if(item.type === 'flash') icon = 'âš¡';
                    if(item.type === 'route') icon = 'ğŸ—ºï¸';
                    
                    div.innerHTML = `
                        <div class="item-title">
                            <span class="item-icon">${icon}</span>${item.title}
                        </div>
                        <div class="item-desc">${item.desc}</div>
                    `;
                    
                    div.addEventListener('click', () => {
                        showItemDetail(item.title, item.desc);
                    });
                    
                    wrapper.appendChild(div);
                });
            };

            // æ¸²æŸ“ä¸¤éä»¥æ”¯æŒæ— ç¼æ»šåŠ¨
            renderItems(recommendations);
            renderItems(recommendations);
            
            console.log('AIæ¨èå·²æ›´æ–°ï¼Œå…±æ¨è ' + recommendations.length + ' é¡¹å†…å®¹');
        }

        // åˆå§‹åŒ–åœ°å›¾å˜é‡
        var map;
        var userMarker;
        var noteMarkers = [];

        // åˆå§‹åŒ–è…¾è®¯åœ°å›¾
        function initMap(lat, lng) {
            var center = new TMap.LatLng(lat, lng);
            // åˆå§‹åŒ–åœ°å›¾
            if (map) {
                map.setCenter(center);
            } else {
                map = new TMap.Map("map-container", {
                    center: center,
                    zoom: 16,
                    pitch: 43.5,
                    rotation: 45,
                    mapStyleId: 'style1' // å¯ç”¨ style1
                });
            }

            // æ›´æ–°AIæ¨èå†…å®¹
            updateRecommendations(lat, lng);

            // æ·»åŠ ç”¨æˆ·å½“å‰ä½ç½®æ ‡è®°
            addMarker(lat, lng, 'æˆ‘çš„ä½ç½®');
            
            // æ·»åŠ ä¸€äº›ç¤ºä¾‹ç¬”è®°ç‚¹ä½ï¼ˆå›´ç»•ä¸­å¿ƒç‚¹éšæœºç”Ÿæˆï¼‰
            addRandomNotes(lat, lng);
        }

        // æ·»åŠ æ ‡è®°å‡½æ•°
        function addMarker(lat, lng, title) {
            var marker = new TMap.MultiMarker({
                map: map,
                styles: {
                    // ç‚¹æ ‡è®°æ ·å¼
                    marker: new TMap.MarkerStyle({ 
                        width: 24,  // ç¼©å°20% (åŸ30)
                        height: 34, // ç¼©å°20% (åŸ42)
                        anchor: { x: 12, y: 34 }, // é”šç‚¹è®¾ä¸ºåº•éƒ¨ä¸­å¿ƒ
                        src: 'location_icon.png' 
                    })
                },
                geometries: [{
                    "id": 'user',
                    "styleId": 'marker',
                    "position": new TMap.LatLng(lat, lng),
                    "properties": {
                        "title": title
                    }
                }]
            });
            if (title === 'æˆ‘çš„ä½ç½®') {
                userMarker = marker;
            }
        }

        // æ·»åŠ éšæœºç¬”è®°ç‚¹ä½
        function addRandomNotes(baseLat, baseLng) {
            var geometries = [];
            for (var i = 0; i < 5; i++) {
                var lat = baseLat + (Math.random() - 0.5) * 0.01;
                var lng = baseLng + (Math.random() - 0.5) * 0.01;
                geometries.push({
                    "id": 'note_' + i,
                    "styleId": 'note',
                    "position": new TMap.LatLng(lat, lng),
                    "properties": {
                        "title": "ç¬”è®°ç‚¹ä½ " + (i + 1)
                    }
                });
            }
            
            var markers = new TMap.MultiMarker({
                map: map,
                styles: {
                    note: new TMap.MarkerStyle({ 
                        width: 30, 
                        height: 30, 
                        anchor: { x: 15, y: 15 }, 
                        src: 'https://p3-flow-imagex-download-sign.byteimg.com/tos-cn-i-a9rns2rl98/1bc04e71b6ce446fa657fb04cf4b7e5e.png~tplv-a9rns2rl98-24:720:720.png?lk3s=8e244e95&rcl=20260219153037A536B57FB3DBE869A22A&rrcfp=8a172a1a&x-expires=1772091037&x-signature=tCBh1O1i0mVbvHg3fky1JIpBqHM%3D' // ä½¿ç”¨æµ·é¸¥å›¾æ ‡ä½œä¸ºç¬”è®°ç‚¹
                    })
                },
                geometries: geometries
            });
            noteMarkers.push(markers);
        }

        // é¡µé¢åŠ è½½å®Œæˆåç«‹å³è‡ªåŠ¨å¼€å§‹å®šä½
        window.addEventListener('DOMContentLoaded', function() {
            
            // åæ ‡è½¬æ¢å·¥å…·å‡½æ•° (WGS84 -> GCJ02)
            // è…¾è®¯åœ°å›¾ä½¿ç”¨ GCJ02 åæ ‡ç³»ï¼ŒHTML5/IP API è¿”å› WGS84ï¼Œç›´æ¥ä½¿ç”¨ä¼šæœ‰åç§»
            function wgs84ToGcj02(lat, lng) {
                if (outOfChina(lat, lng)) {
                    return { lat: lat, lng: lng };
                }
                const a = 6378245.0;
                const ee = 0.00669342162296594323;
                let dLat = transformLat(lng - 105.0, lat - 35.0);
                let dLng = transformLng(lng - 105.0, lat - 35.0);
                const radLat = lat / 180.0 * Math.PI;
                let magic = Math.sin(radLat);
                magic = 1 - ee * magic * magic;
                const sqrtMagic = Math.sqrt(magic);
                dLat = (dLat * 180.0) / ((a * (1 - ee)) / (magic * sqrtMagic) * Math.PI);
                dLng = (dLng * 180.0) / (a / sqrtMagic * Math.cos(radLat) * Math.PI);
                const mgLat = lat + dLat;
                const mgLng = lng + dLng;
                return { lat: mgLat, lng: mgLng };
            }

            function transformLat(x, y) {
                let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
                ret += (20.0 * Math.sin(6.0 * x * Math.PI) + 20.0 * Math.sin(2.0 * x * Math.PI)) * 2.0 / 3.0;
                ret += (20.0 * Math.sin(y * Math.PI) + 40.0 * Math.sin(y / 3.0 * Math.PI)) * 2.0 / 3.0;
                ret += (160.0 * Math.sin(y / 12.0 * Math.PI) + 320 * Math.sin(y * Math.PI / 30.0)) * 2.0 / 3.0;
                return ret;
            }

            function transformLng(x, y) {
                let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
                ret += (20.0 * Math.sin(6.0 * x * Math.PI) + 20.0 * Math.sin(2.0 * x * Math.PI)) * 2.0 / 3.0;
                ret += (20.0 * Math.sin(x * Math.PI) + 40.0 * Math.sin(x / 3.0 * Math.PI)) * 2.0 / 3.0;
                ret += (150.0 * Math.sin(x / 12.0 * Math.PI) + 300.0 * Math.sin(x / 30.0 * Math.PI)) * 2.0 / 3.0;
                return ret;
            }

            function outOfChina(lat, lng) {
                if (lng < 72.004 || lng > 137.8347) {
                    return true;
                }
                if (lat < 0.8293 || lat > 55.8271) {
                    return true;
                }
                return false;
            }

            // å¯åŠ¨è‡ªåŠ¨å®šä½
            function startAutoLocation() {
                showToast('æ­£åœ¨è‡ªåŠ¨è·å–å®šä½...');
                
                // æ ‡è®°å®šä½æ˜¯å¦å·²å®Œæˆï¼ˆé¿å…é‡å¤å¤„ç†ï¼‰
                let locationDone = false;
                
                // æ‰‹åŠ¨å¼ºåˆ¶è¶…æ—¶è®¡æ—¶å™¨ (5ç§’)
                const manualTimeoutId = setTimeout(function() {
                    if (!locationDone) {
                        locationDone = true;
                        handleIpError({ code: 3, message: 'å®šä½å¼ºåˆ¶è¶…æ—¶(5s)' });
                    }
                }, 5000);

                // ä¼˜å…ˆä½¿ç”¨ HTML5 Geolocation API
                if (navigator.geolocation) {
                    const options = {
                        enableHighAccuracy: true, // å¼€å¯é«˜ç²¾åº¦
                        timeout: 5000,            // 5ç§’è¶…æ—¶
                        maximumAge: 0             // ç¦ç”¨ç¼“å­˜
                    };

                    navigator.geolocation.getCurrentPosition(
                        // æˆåŠŸå›è°ƒ
                        function(position) {
                            if (locationDone) return; // å¦‚æœå·²è¶…æ—¶ï¼Œåˆ™å¿½ç•¥æˆåŠŸå›è°ƒ
                            locationDone = true;
                            clearTimeout(manualTimeoutId); // æ¸…é™¤å¼ºåˆ¶è¶…æ—¶è®¡æ—¶å™¨

                            let lat = position.coords.latitude;
                            let lng = position.coords.longitude;
                            const accuracy = position.coords.accuracy;
                            
                            // åæ ‡è½¬æ¢ï¼šWGS84 -> GCJ02
                            const gcjPoint = wgs84ToGcj02(lat, lng);
                            lat = gcjPoint.lat;
                            lng = gcjPoint.lng;

                            showToast(`GPSå®šä½æˆåŠŸ (è¯¯å·®: ${Math.round(accuracy)}ç±³)`);
                            console.log('HTML5 å®šä½æˆåŠŸ(GCJ02)ï¼š', lat, lng, 'åŸå§‹ç²¾åº¦', accuracy);
                            
                            // åˆå§‹åŒ–åœ°å›¾å’Œä¸šåŠ¡
                            initMap(lat, lng);
                            updateWeather(lat, lng);
                        },
                        // å¤±è´¥å›è°ƒ
                        function(error) {
                            if (locationDone) return;
                            locationDone = true;
                            clearTimeout(manualTimeoutId);

                            let errorMsg = 'å®šä½å¤±è´¥';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMsg = 'ç”¨æˆ·æ‹’ç»äº†å®šä½è¯·æ±‚';
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMsg = 'ä½ç½®ä¿¡æ¯ä¸å¯ç”¨';
                                    break;
                                case error.TIMEOUT:
                                    errorMsg = 'å®šä½è¯·æ±‚è¶…æ—¶';
                                    break;
                                case error.UNKNOWN_ERROR:
                                    errorMsg = 'å‘ç”ŸæœªçŸ¥é”™è¯¯';
                                    break;
                            }
                            console.warn('HTML5 å®šä½å¤±è´¥:', errorMsg, error);
                            // ç›´æ¥è°ƒç”¨é”™è¯¯å¤„ç†ï¼Œé™çº§åˆ°é»˜è®¤ä½ç½®
                            handleIpError(errorMsg);
                        },
                        options
                    );
                } else {
                    // æµè§ˆå™¨ä¸æ”¯æŒ HTML5 å®šä½
                    if (!locationDone) {
                        locationDone = true;
                        clearTimeout(manualTimeoutId);
                        handleIpError('æµè§ˆå™¨ä¸æ”¯æŒå®šä½ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®');
                    }
                }
            }

            // ç«‹å³æ‰§è¡Œè‡ªåŠ¨å®šä½
            startAutoLocation();

            // ç§»é™¤ tryIpGeolocation å‡½æ•°å’Œ handleIpSuccess å‡½æ•°ï¼Œå½»åº•ç¦ç”¨ç½‘ç»œå®šä½é™çº§


            function handleIpError(err) {
                console.warn('å®šä½é™çº§:', err);
                
                // å®šä½å¤±è´¥æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°é»˜è®¤ä½ç½®ï¼ˆæ˜†æ˜ï¼‰
                const defaultLat = 24.8801;
                const defaultLng = 102.8329;
                const defaultCity = 'æ˜†æ˜å¸‚';
                
                showToast('å®šä½å¤±è´¥ï¼Œè‡ªåŠ¨åˆ‡æ¢è‡³é»˜è®¤åŸå¸‚(æ˜†æ˜)');
                console.log('å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤åæ ‡ï¼š', defaultCity, defaultLat, defaultLng);
                
                // åˆå§‹åŒ–åœ°å›¾å’Œå¤©æ°”
                initMap(defaultLat, defaultLng);
                updateWeather(defaultLat, defaultLng, defaultCity);
            }
        });
        
        // æ˜¾ç¤ºæ‰‹åŠ¨é€‰æ‹©å®šä½ç•Œé¢ï¼ˆæ¢å¤ä¸ºåˆå§‹ä»£ç ä¸­çš„ç®€å•åˆ—è¡¨æ¨¡å¼ï¼‰
        function showManualLocationModal() {
            // åˆ›å»ºé®ç½©å±‚
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            document.body.appendChild(overlay);
            
            // åˆ›å»ºæ‰‹åŠ¨é€‰æ‹©å®šä½å¼¹çª—
            const manualModal = document.createElement('div');
            manualModal.className = 'manual-location-modal';
            manualModal.innerHTML = `
                <div class="manual-location-title">æ‰‹åŠ¨é€‰æ‹©å®šä½</div>
                <div class="city-list">
                    <div class="city-item" data-city="æ˜†æ˜" data-lat="24.8801" data-lng="102.8329">æ˜†æ˜</div>
                    <div class="city-item" data-city="å¤§ç†" data-lat="25.6065" data-lng="100.2676">å¤§ç†</div>
                    <div class="city-item" data-city="ä¸½æ±Ÿ" data-lat="26.8550" data-lng="100.2260">ä¸½æ±Ÿ</div>
                    <div class="city-item" data-city="å»ºæ°´" data-lat="23.6347" data-lng="102.8329">å»ºæ°´</div>
                    <div class="city-item" data-city="è¥¿åŒç‰ˆçº³" data-lat="22.0017" data-lng="100.7979">è¥¿åŒç‰ˆçº³</div>
                </div>
                <button class="confirm-city-btn">ç¡®è®¤é€‰æ‹©</button>
            `;
            document.body.appendChild(manualModal);
            
            // åŸå¸‚é€‰æ‹©é€»è¾‘
            let selectedCity = 'æ˜†æ˜'; // é»˜è®¤é€‰ä¸­æ˜†æ˜
            let selectedLat = 24.8801;
            let selectedLng = 102.8329;
            
            const cityItems = manualModal.querySelectorAll('.city-item');
            const confirmBtn = manualModal.querySelector('.confirm-city-btn');
            
            // åˆå§‹åŒ–é»˜è®¤é€‰ä¸­æ ·å¼
            cityItems[0].style.background = '#f0e6ff';
            cityItems[0].style.color = '#9d65ff';
            
            // åŸå¸‚ç‚¹å‡»äº‹ä»¶
            cityItems.forEach(item => {
                item.addEventListener('click', function() {
                    // é‡ç½®æ‰€æœ‰åŸå¸‚æ ·å¼
                    cityItems.forEach(i => {
                        i.style.background = '';
                        i.style.color = '';
                    });
                    // è®¾ç½®å½“å‰é€‰ä¸­æ ·å¼
                    this.style.background = '#f0e6ff';
                    this.style.color = '#9d65ff';
                    selectedCity = this.dataset.city;
                    selectedLat = parseFloat(this.dataset.lat);
                    selectedLng = parseFloat(this.dataset.lng);
                });
            });
            
            // ç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            confirmBtn.addEventListener('click', function() {
                document.body.removeChild(manualModal);
                document.body.removeChild(overlay);
                showToast(`å·²é€‰æ‹©${selectedCity}ä½œä¸ºå®šä½åŸå¸‚`);
                console.log('æ‰‹åŠ¨é€‰æ‹©å®šä½ï¼š', selectedCity, selectedLat, selectedLng);
                
                // åˆå§‹åŒ–åœ°å›¾å’Œå¤©æ°”
                initMap(selectedLat, selectedLng);
                updateWeather(selectedLat, selectedLng, selectedCity);
            });
        }
        
        // æ¨¡æ‹Ÿå¤©æ°”æ›´æ–°
        function updateWeather(lat, lng, cityName) {
            const widget = document.getElementById('weatherWidget');
            if (!widget) return;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            widget.innerHTML = `
                <span class="weather-icon">âŒ›</span>
                <span class="weather-temp">--Â°C</span>
                <span class="weather-city">${cityName || 'å®šä½ä¸­...'}</span>
            `;

            // 1. è·å–å¤©æ°”æ•°æ® (ä½¿ç”¨ Open-Meteo å…è´¹ API)
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&timezone=auto`)
                .then(response => response.json())
                .then(data => {
                    const weather = data.current_weather;
                    const temp = Math.round(weather.temperature);
                    const wmoCode = weather.weathercode;
                    const icon = getWeatherIcon(wmoCode);
                    
                    // 2. å¦‚æœæ²¡æœ‰åŸå¸‚åç§°ï¼Œå°è¯•è·å– (ä½¿ç”¨ Nominatim å…è´¹é€†åœ°ç†ç¼–ç )
                    if (!cityName) {
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&accept-language=zh-CN`)
                            .then(resp => resp.json())
                            .then(geoData => {
                                let city = 'æœªçŸ¥åŸå¸‚';
                                if (geoData.address) {
                                    city = geoData.address.city || geoData.address.town || geoData.address.county || geoData.address.state || 'æœªçŸ¥';
                                    city = city.replace('å¸‚', '').replace('è‡ªæ²»å·', '').replace('åœ°åŒº', '');
                                }
                                updateWidget(icon, temp, city);
                            })
                            .catch(() => {
                                updateWidget(icon, temp, 'æœ¬åœ°');
                            });
                    } else {
                        updateWidget(icon, temp, cityName);
                    }
                })
                .catch(err => {
                    console.error('å¤©æ°”è·å–å¤±è´¥:', err);
                    widget.innerHTML = `
                        <span class="weather-icon">âš ï¸</span>
                        <span class="weather-temp">--</span>
                        <span class="weather-city">ç¦»çº¿</span>
                    `;
                });

            function updateWidget(icon, temp, city) {
                // å¤„ç†åŸå¸‚åç§°ï¼Œé¿å…å¤ªé•¿
                if (city.length > 4) city = city.substring(0, 4);
                
                widget.innerHTML = `
                    <span class="weather-icon">${icon}</span>
                    <span class="weather-temp">${temp}Â°C</span>
                    <span class="weather-city">${city}</span>
                `;
            }

            // WMO å¤©æ°”ä»£ç æ˜ å°„å›¾æ ‡
            function getWeatherIcon(code) {
                // 0: æ™´å¤©
                if (code === 0) return 'â˜€ï¸';
                // 1, 2, 3: å¤šäº‘
                if ([1, 2, 3].includes(code)) return 'â›…';
                // 45, 48: é›¾
                if ([45, 48].includes(code)) return 'ğŸŒ«ï¸';
                // 51, 53, 55, 56, 57: æ¯›æ¯›é›¨
                if ([51, 53, 55, 56, 57].includes(code)) return 'ğŸŒ§ï¸';
                // 61, 63, 65, 66, 67: é›¨
                if ([61, 63, 65, 66, 67].includes(code)) return 'ğŸŒ§ï¸';
                // 71, 73, 75, 77: é›ª
                if ([71, 73, 75, 77].includes(code)) return 'â„ï¸';
                // 80, 81, 82: é˜µé›¨
                if ([80, 81, 82].includes(code)) return 'ğŸŒ¦ï¸';
                // 85, 86: é˜µé›ª
                if ([85, 86].includes(code)) return 'ğŸŒ¨ï¸';
                // 95, 96, 99: é›·é›¨
                if ([95, 96, 99].includes(code)) return 'â›ˆï¸';
                
                return 'ğŸŒ¤ï¸'; // é»˜è®¤
            }
        }
        
        // æç¤ºæ¡†å‡½æ•°
        function showToast(message) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                font-size: 14px;
                z-index: 9999;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // æ˜¾ç¤ºæç¤º
            setTimeout(() => {
                toast.style.opacity = '1';
            }, 10);
            
            // 3ç§’åéšè—
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // AIä¼´æ¸¸æŒ‰é’®æ‹–æ‹½åŠŸèƒ½
        const aiBtn = document.getElementById('ai-btn');
        let isAiDragging = false;
        let aiStartX, aiStartY;
        let aiInitialLeft, aiInitialTop;
        let aiClickTime;

        // é¼ æ ‡æŒ‰ä¸‹/è§¦æ‘¸å¼€å§‹
        function startAiDrag(e) {
            isAiDragging = false; // åˆå§‹ä¸è§†ä¸ºæ‹–åŠ¨
            aiClickTime = new Date().getTime();
            
            const clientX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
            const clientY = e.type === 'mousedown' ? e.clientY : e.touches[0].clientY;
            
            aiStartX = clientX;
            aiStartY = clientY;
            
            // è·å–å½“å‰ä½ç½®ï¼ˆç›¸å¯¹äºè§†å£ï¼‰
            const rect = aiBtn.getBoundingClientRect();
            // è®¡ç®—ç›¸å¯¹äºçˆ¶å®¹å™¨ï¼ˆ.screen-contentï¼‰çš„åç§»
            // æ³¨æ„ï¼šå› ä¸ºçˆ¶å®¹å™¨æ˜¯ relativeï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬æ¢ä¸º top/left å®šä½
            // å…ˆæ¸…é™¤ bottom/rightï¼Œæ”¹ä¸º top/left
            if (aiBtn.style.bottom) {
                aiBtn.style.top = aiBtn.offsetTop + 'px';
                aiBtn.style.left = aiBtn.offsetLeft + 'px';
                aiBtn.style.bottom = 'auto';
                aiBtn.style.right = 'auto';
            }
            
            aiInitialLeft = aiBtn.offsetLeft;
            aiInitialTop = aiBtn.offsetTop;
            
            // ç»‘å®šç§»åŠ¨å’Œç»“æŸäº‹ä»¶åˆ° documentï¼Œé˜²æ­¢å¿«é€Ÿæ‹–åŠ¨è„±ç¦»å…ƒç´ 
            document.addEventListener('mousemove', onAiDrag);
            document.addEventListener('touchmove', onAiDrag, { passive: false });
            document.addEventListener('mouseup', endAiDrag);
            document.addEventListener('touchend', endAiDrag);
        }

        // ç§»åŠ¨ä¸­
        function onAiDrag(e) {
            const clientX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
            const clientY = e.type === 'mousemove' ? e.clientY : e.touches[0].clientY;
            
            const deltaX = clientX - aiStartX;
            const deltaY = clientY - aiStartY;
            
            // åªæœ‰ç§»åŠ¨è·ç¦»è¶…è¿‡ä¸€å®šé˜ˆå€¼æ‰è§†ä¸ºæ‹–åŠ¨ï¼Œé¿å…ç‚¹å‡»è¯¯åˆ¤
            if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                isAiDragging = true;
                e.preventDefault(); // é˜²æ­¢æ»šåŠ¨
            }
            
            if (isAiDragging) {
                let newLeft = aiInitialLeft + deltaX;
                let newTop = aiInitialTop + deltaY;
                
                // è¾¹ç•Œé™åˆ¶
                const container = document.querySelector('.screen-content');
                const maxX = container.offsetWidth - aiBtn.offsetWidth;
                const maxY = container.offsetHeight - aiBtn.offsetHeight;
                
                newLeft = Math.max(0, Math.min(newLeft, maxX));
                newTop = Math.max(0, Math.min(newTop, maxY));
                
                aiBtn.style.left = newLeft + 'px';
                aiBtn.style.top = newTop + 'px';
            }
        }

        // ç»“æŸæ‹–åŠ¨
        function endAiDrag(e) {
            document.removeEventListener('mousemove', onAiDrag);
            document.removeEventListener('touchmove', onAiDrag);
            document.removeEventListener('mouseup', endAiDrag);
            document.removeEventListener('touchend', endAiDrag);
            
            // å¦‚æœæ˜¯ç‚¹å‡»æ“ä½œï¼ˆæœªå‘ç”Ÿæ‹–åŠ¨æˆ–æ—¶é—´å¾ˆçŸ­ï¼‰ï¼Œåˆ™è§¦å‘ç‚¹å‡»äº‹ä»¶é€»è¾‘
            const timeDiff = new Date().getTime() - aiClickTime;
            if (!isAiDragging && timeDiff < 200) {
                showAiDialog();
            }
        }

        aiBtn.addEventListener('mousedown', startAiDrag);
        aiBtn.addEventListener('touchstart', startAiDrag, { passive: false });

        // å°†åŸæœ¬çš„ç‚¹å‡»äº‹ä»¶é€»è¾‘å°è£…ä¸ºå‡½æ•°
        function showAiDialog() {
            // å¦‚æœå·²ç»å­˜åœ¨èŠå¤©çª—å£ï¼Œåˆ™ä¸é‡å¤åˆ›å»º
            if (document.querySelector('.chat-modal')) return;
            
            const chatModal = document.createElement('div');
            chatModal.className = 'chat-modal';
            chatModal.innerHTML = `
                <div class="chat-header">
                    <div class="chat-title">
                        <img src="./æµ·é¸¥.png" class="seagull-span-icon" alt="æµ·é¸¥å›¾æ ‡"> æµ·é¸¥ä¼´æ¸¸åŠ©æ‰‹
                    </div>
                    <div class="chat-close">Ã—</div>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <!-- æ¶ˆæ¯ç”±JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="chat-input-area">
                    <div class="text-input-row">
                        <div class="input-wrapper">
                            <input type="text" class="chat-input" placeholder="è¾“å…¥é—®é¢˜..." id="chat-input">
                        </div>
                        <button class="action-btn send-btn" id="chat-send">â¤</button>
                    </div>
                    <div class="voice-input-row">
                        <button class="voice-hold-btn" id="voice-hold-btn">
                            <span style="font-size: 18px;">ğŸ¤</span> æŒ‰ä½ è¯´è¯
                        </button>
                    </div>
                </div>
            `;
            // å°†èŠå¤©çª—å£æ·»åŠ åˆ° .screen-content ä¸­ï¼Œè€Œä¸æ˜¯ body
            document.querySelector('.screen-content').appendChild(chatModal);
            
            // å…³é—­æŒ‰é’®
            chatModal.querySelector('.chat-close').addEventListener('click', () => {
                chatModal.style.animation = 'slideDown 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28)';
                setTimeout(() => {
                    chatModal.remove();
                    // åœæ­¢è¯­éŸ³æœ—è¯»
                    if (window.speechSynthesis) {
                        window.speechSynthesis.cancel();
                    }
                }, 280);
            });
            
            // æ·»åŠ  slideDown åŠ¨ç”»
            if (!document.getElementById('slideDownAnim')) {
                const style = document.createElement('style');
                style.id = 'slideDownAnim';
                style.textContent = `
                    @keyframes slideDown {
                        0% { transform: translateY(0); }
                        100% { transform: translateY(100%); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            const input = document.getElementById('chat-input');
            const sendBtn = document.getElementById('chat-send');
            const messagesContainer = document.getElementById('chat-messages');

            // æ¬¢è¿è¯­é€»è¾‘ï¼šåˆ†æ®µå‘é€
            const welcomeMsg1 = "å“Ÿï½æˆ‘æ˜¯ä½ çš„ â€œæœ¬åœ°æ´»åœ°å›¾â€ é˜¿æ˜†ï¼";
            const welcomeMsg2 = "æƒ³åƒåœ°é“ç¾é£Ÿï¼Ÿæƒ³æ‰¾æœ€æœ‰è¶£çš„æ´»åŠ¨ï¼Ÿæƒ³ç©ç‚¹ä¸ä¸€æ ·çš„ï¼Ÿç»Ÿç»Ÿäº¤ç»™æˆ‘ï¼æœ¬åœ°äººç§è—çš„å®è—æˆ‘éƒ½ç»™ä½ æŒ–å‡ºæ¥ï¼Œæ— èŠäº†è¿˜èƒ½é™ªä½ å” äº”æ¯›é’±çš„ï¼Œæœ‰å•¥å°½ç®¡å©å’ï½";

            // 0.5ç§’åå‘é€ç¬¬ä¸€æ®µ
            setTimeout(() => {
                showLoading(); // å…ˆæ˜¾ç¤ºè¾“å…¥ä¸­
                setTimeout(() => {
                    const loadingEl = document.querySelector('.typing-indicator');
                    if (loadingEl) loadingEl.remove();
                    appendMessage(welcomeMsg1, 'ai');
                    
                    // 1ç§’åå†å‘é€ç¬¬äºŒæ®µ
                    setTimeout(() => {
                        showLoading();
                        setTimeout(() => {
                            const loadingEl2 = document.querySelector('.typing-indicator');
                            if (loadingEl2) loadingEl2.remove();
                            appendMessage(welcomeMsg2, 'ai');
                        }, 800); // æ¨¡æ‹Ÿæ‰“å­—æ—¶é—´
                    }, 1000); // 1ç§’å»¶è¿Ÿ
                }, 500); // 0.5ç§’å»¶è¿Ÿ
            }, 100);

            // è¯­éŸ³è¾“å…¥åŠŸèƒ½ (æŒ‰ä½è¯´è¯æ¨¡å¼)
            const voiceBtn = document.getElementById('voice-hold-btn');
            let recognition;
            let isRecording = false;

            // è¾“å…¥æ¡†ç›‘å¬ï¼Œæ§åˆ¶å‘é€æŒ‰é’®çŠ¶æ€
            input.addEventListener('input', () => {
                if (input.value.trim()) {
                    sendBtn.classList.add('active');
                } else {
                    sendBtn.classList.remove('active');
                }
            });

            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = false;
                recognition.interimResults = true;

                recognition.onstart = () => {
                    isRecording = true;
                    voiceBtn.classList.add('recording');
                    voiceBtn.innerHTML = '<span class="typing-dot" style="background:white"></span> æ­£åœ¨è†å¬...';
                    input.placeholder = "æ­£åœ¨æ¥æ”¶è¯­éŸ³...";
                    input.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
                    sendBtn.classList.remove('active'); // å½•éŸ³å¼€å§‹æ—¶ç¦ç”¨å‘é€æŒ‰é’®
                };

                recognition.onend = () => {
                    isRecording = false;
                    voiceBtn.classList.remove('recording');
                    voiceBtn.innerHTML = '<span style="font-size: 18px;">ğŸ¤</span> æŒ‰ä½ è¯´è¯';
                    input.placeholder = "è¾“å…¥é—®é¢˜...";
                    
                    // å½•éŸ³ç»“æŸï¼Œå¦‚æœæœ‰å†…å®¹ï¼Œè‡ªåŠ¨å‘é€ï¼›å¦åˆ™åªæ›´æ–°æŒ‰é’®çŠ¶æ€
                    if (input.value.trim()) {
                        sendBtn.classList.add('active'); // ç¡®ä¿æŒ‰é’®æ¿€æ´»
                        sendMessage();
                    }
                };

                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        input.value = finalTranscript;
                    } else if (interimTranscript) {
                        input.value = interimTranscript;
                    }
                    
                    // å®æ—¶æ›´æ–°æŒ‰é’®çŠ¶æ€
                    if (input.value.trim()) {
                        sendBtn.classList.add('active');
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('Voice error:', event.error);
                    isRecording = false;
                    voiceBtn.classList.remove('recording');
                    voiceBtn.innerHTML = '<span style="font-size: 18px;">ğŸ¤</span> æŒ‰ä½ è¯´è¯';
                    
                    let errorMsg = "è¯­éŸ³è¯†åˆ«å¤±è´¥";
                    if (event.error === 'not-allowed') errorMsg = "è¯·å…è®¸éº¦å…‹é£æƒé™";
                    if (event.error === 'no-speech') errorMsg = "æœªæ£€æµ‹åˆ°è¯­éŸ³";
                    
                    input.placeholder = errorMsg;
                    setTimeout(() => {
                        input.placeholder = "è¾“å…¥é—®é¢˜...";
                    }, 2000);
                };

                // æŒ‰ä½å¼€å§‹
                const startRecording = (e) => {
                    e.preventDefault(); // é˜²æ­¢é»˜è®¤è¡Œä¸º
                    if (isRecording) return;
                    try {
                        recognition.start();
                    } catch (err) {
                        console.error(err);
                    }
                };

                // æ¾å¼€ç»“æŸ
                const stopRecording = (e) => {
                    if (!isRecording) return;
                    try {
                        recognition.stop();
                    } catch (err) {
                        console.error(err);
                    }
                };

                voiceBtn.addEventListener('mousedown', startRecording);
                voiceBtn.addEventListener('touchstart', startRecording);
                
                document.addEventListener('mouseup', (e) => {
                    if (isRecording) stopRecording(e);
                });
                document.addEventListener('touchend', (e) => {
                    if (isRecording) stopRecording(e);
                });

            } else {
                // ä¸æ”¯æŒæ—¶çš„å›é€€å¤„ç†
                voiceBtn.addEventListener('click', () => {
                    alert('æŠ±æ­‰ï¼Œä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥åŠŸèƒ½ã€‚');
                });
            }
            
            // å‘é€æ¶ˆæ¯åŠŸèƒ½
            function sendMessage() {
                const text = input.value.trim();
                if (!text) return;
                
                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
                appendMessage(text, 'user');
                input.value = '';
                sendBtn.classList.remove('active'); // å‘é€åç¦ç”¨æŒ‰é’®
                
                // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
                const loadingId = showLoading();
                
                // è°ƒç”¨åç«¯ API
                fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: text })
                })
                .then(response => response.json())
                .then(data => {
                    removeLoading(loadingId);
                    // å…¼å®¹å¤šç§APIè¿”å›æ ¼å¼
                    if (data.output && data.output.text) {
                        appendMessage(data.output.text, 'ai');
                    } else if (data.output && data.output.choices && data.output.choices[0] && data.output.choices[0].message) {
                        appendMessage(data.output.choices[0].message.content, 'ai');
                    } else if (data.error) {
                        appendMessage('æŠ±æ­‰ï¼Œç”±äºç½‘ç»œé—®é¢˜ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”ã€‚(' + data.error + ')', 'ai');
                    } else {
                        appendMessage('æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰å¬æ¸…ï¼Œè¯·å†è¯´ä¸€éã€‚', 'ai');
                    }
                })
                .catch(err => {
                    removeLoading(loadingId);
                    appendMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚', 'ai');
                    console.error(err);
                });
            }
            
            // ç»‘å®šå‘é€äº‹ä»¶
            sendBtn.addEventListener('click', sendMessage);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            function appendMessage(text, type) {
                const msgDiv = document.createElement('div');
                msgDiv.className = `message ${type}`;
                msgDiv.textContent = text;
                
                messagesContainer.appendChild(msgDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // å¦‚æœæ˜¯ AI æ¶ˆæ¯ï¼Œè‡ªåŠ¨æœ—è¯»
                if (type === 'ai') {
                    speakText(text);
                }
            }

            function speakText(text) {
                // æµè§ˆå™¨é»˜è®¤æ˜¯é˜Ÿåˆ—æœºåˆ¶ï¼Œä¸ cancel å°±ä¼šæ’é˜Ÿã€‚
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 1.2; // 1.2å€é€Ÿ
                utterance.pitch = 1.4; // æé«˜éŸ³è°ƒæ¨¡æ‹Ÿå„¿ç«¥éŸ³

                // å°è¯•é€‰æ‹©ä¸­æ–‡è¯­éŸ³
                const voices = window.speechSynthesis.getVoices();
                // ä¼˜å…ˆæ‰¾ä¸­æ–‡
                const zhVoice = voices.find(v => v.lang.includes('zh') || v.lang.includes('CN'));
                if (zhVoice) {
                    utterance.voice = zhVoice;
                }
                
                window.speechSynthesis.speak(utterance);
            }
            
            function showLoading() {
                const id = 'loading-' + Date.now();
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message ai typing-indicator';
                msgDiv.id = id;
                msgDiv.innerHTML = `
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                `;
                messagesContainer.appendChild(msgDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                return id;
            }
            
            function removeLoading(id) {
                const el = document.getElementById(id);
                if (el) el.remove();
            }
        }

        // ç§»é™¤æ—§çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰çš„è¯ï¼Œä½†è¿™é‡Œæˆ‘ä»¬ç›´æ¥æ›¿æ¢é€»è¾‘ï¼‰
        // æ³¨æ„ï¼šåŸä»£ç ä¸­çš„ click äº‹ä»¶ç›‘å¬å™¨éœ€è¦è¢«ç§»é™¤æˆ–æ›¿æ¢ï¼Œå¦åˆ™ä¼šå†²çª
        // å»ºè®®åˆ é™¤åŸä»£ç ä¸­çš„ ai-btn click ç›‘å¬å™¨éƒ¨åˆ†


        // åŠŸèƒ½æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.func-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // è·å–æŒ‰é’®æ–‡æœ¬ï¼ˆä¼˜å…ˆä»spanè·å–ï¼Œå…¼å®¹æ—§ç»“æ„ï¼‰
                const span = btn.querySelector('span');
                const btnText = span ? span.textContent : btn.textContent.trim();
                
                const alertBox = document.createElement('div');
                alertBox.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 20px;
                    border-radius: 16px;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.2);
                    width: 260px;
                    z-index: 9999;
                    text-align: center;
                    font-size: 15px;
                    color: #333;
                `;
                alertBox.innerHTML = `
                    <div style="margin-bottom: 16px;">ã€åŠŸèƒ½å¼€å‘ä¸­ã€‘</div>
                    <div style="font-size: 14px; color: #666; margin-bottom: 16px;">æ•¬è¯·æœŸå¾…...</div>
                    <button style="
                        padding: 8px 24px;
                        background: #14b6fa;
                        color: white;
                        border: none;
                        border-radius: 20px;
                        font-size: 14px;
                        cursor: pointer;
                    ">ç¡®å®š</button>
                `;
                document.body.appendChild(alertBox);
                
                alertBox.querySelector('button').addEventListener('click', () => {
                    document.body.removeChild(alertBox);
                });
            });
        });

        // æ¨èé¡¹ç‚¹å‡»äº‹ä»¶å·²ç§»è‡³ updateRecommendations å‡½æ•°ä¸­åŠ¨æ€ç»‘å®š

        // æ‰‹åŠ¨æ»‘åŠ¨åŠŸèƒ½
        const scrollContainer = document.getElementById('recommend-scroll');
        let isDragging = false;
        let startX;
        let scrollLeft;

        scrollContainer.addEventListener('mousedown', startDrag);
        scrollContainer.addEventListener('touchstart', startDrag, { passive: true });
        scrollContainer.addEventListener('mousemove', drag);
        scrollContainer.addEventListener('touchmove', drag, { passive: true });
        scrollContainer.addEventListener('mouseup', endDrag);
        scrollContainer.addEventListener('mouseleave', endDrag);
        scrollContainer.addEventListener('touchend', endDrag);

        function startDrag(e) {
            isDragging = true;
            scrollContainer.classList.add('dragging');
            startX = (e.type === 'mousedown' ? e.pageX : e.touches[0].pageX) - scrollContainer.offsetLeft;
            scrollLeft = scrollContainer.scrollLeft;
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            const x = (e.type === 'mousemove' ? e.pageX : e.touches[0].pageX) - scrollContainer.offsetLeft;
            const walk = (x - startX) * 1.5;
            scrollContainer.scrollLeft = scrollLeft - walk;
        }

        function endDrag() {
            isDragging = false;
            scrollContainer.classList.remove('dragging');
        }

        // æ»šåŠ¨æ—¶æš‚åœè‡ªåŠ¨åŠ¨ç”»
        let scrollTimer;
        scrollContainer.addEventListener('scroll', () => {
            const scrollWrapper = scrollContainer.querySelector('.scroll-wrapper');
            scrollWrapper.style.animationPlayState = 'paused';
            
            clearTimeout(scrollTimer);
            scrollTimer = setTimeout(() => {
                scrollWrapper.style.animationPlayState = 'running';
            }, 1000);
        });

        // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('viewDetailsBtn').addEventListener('click', () => {
            showToast('æ­£åœ¨ä¸ºä½ è·³è½¬è‡³è¯¦æƒ…åˆ—è¡¨...');
        });

        // æ›´å¤šåŠŸèƒ½å±•å¼€/æ”¶èµ·é€»è¾‘
        const functionPanel = document.getElementById('functionPanel');
        const moreTrigger = document.getElementById('moreTrigger');
        const dragHandle = document.getElementById('dragHandle');
        const moreArrow = moreTrigger.querySelector('.more-arrow');
        let isExpanded = false;

        function toggleFunctionPanel(expand) {
            isExpanded = expand !== undefined ? expand : !isExpanded;
            
            if (isExpanded) {
                functionPanel.classList.add('expanded');
                moreTrigger.innerHTML = 'æ”¶èµ· <span class="more-arrow">â–²</span>';
            } else {
                functionPanel.classList.remove('expanded');
                moreTrigger.innerHTML = 'æ›´å¤šåŠŸèƒ½ <span class="more-arrow">â–¼</span>';
            }
        }

        moreTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleFunctionPanel();
        });

        // æ‹–æ‹½æ¡ç‚¹å‡»äº‹ä»¶
        dragHandle.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleFunctionPanel();
        });

        // åŠŸèƒ½åŒºæ»‘åŠ¨é€»è¾‘
        let funcStartY;
        let funcIsDragging = false;

        functionPanel.addEventListener('touchstart', (e) => {
            // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸è¦é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå¦åˆ™æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¯èƒ½å¤±æ•ˆ
            if (e.target.closest('.func-btn') || e.target.closest('.more-func-trigger')) {
                // ä¸åšå¤„ç†ï¼Œå…è®¸ç‚¹å‡»ç©¿é€
            }
            funcStartY = e.touches[0].clientY;
            funcIsDragging = true;
        }, { passive: true });

        functionPanel.addEventListener('touchmove', (e) => {
            if (!funcIsDragging) return;
            const currentY = e.touches[0].clientY;
            const diffY = funcStartY - currentY;

            // å‘ä¸Šæ»‘åŠ¨ä¸”æœªå±•å¼€ -> å±•å¼€
            if (diffY > 30 && !isExpanded) {
                toggleFunctionPanel(true);
                funcIsDragging = false;
            }
            // å‘ä¸‹æ»‘åŠ¨ä¸”å·²å±•å¼€ -> æ”¶èµ·
            else if (diffY < -30 && isExpanded) {
                toggleFunctionPanel(false);
                funcIsDragging = false;
            }
        }, { passive: true });

        functionPanel.addEventListener('touchend', () => {
            funcIsDragging = false;
        });

        // ç‚¹å‡»åŠŸèƒ½åŒºå¤–éƒ¨æ”¶èµ· (å¯é€‰)
        document.querySelector('.screen-content').addEventListener('click', (e) => {
            if (isExpanded && !functionPanel.contains(e.target)) {
                toggleFunctionPanel(false);
            }
        });
        // é»˜è®¤åˆå§‹åŒ–æ¨èå†…å®¹ (æ˜†æ˜)
        updateRecommendations(24.8801, 102.8329);
    </script>
</body>
</html>